<style>
    .form-control[readonly],
    .form-control[readonly]:focus {
        background: transparent;
        outline: 0;
        border: 0;
        box-shadow: 0 0 0;
        min-width: 100px;
    }
</style>
<div class="container-fluid">
    <form id="save_invoice" action="" method="post">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex">
                <p class="h3 m-0 mr-3">Product Checkout</p>
                <span class="badge badge-primary badge-sm text-capitalize">
                    <input type="text" style="width: 50px;" class=" text-center form-control form-control-sm text-light font-weight-bold" readonly name="invoice_id">
                </span>
            </div>
            <div class="d-flex">
                <button class="btn btn-success mr-2 save_invoice" type="button"><i class="fa fa-save"></i> Save Changes</button>
                <button class="btn btn-danger exit_invoice" type="button"><i class="fa fa-times"></i></button>
            </div>
        </div>
        <hr>
        <div class="alert-holder"></div>
        <div class="card mb-3">
            <div class="card-body">
                <p class="m-0 h5">Customer Details</p>
                <hr>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="">Mobile</label>
                            <input type="text" name="customer[mobile]" maxlength="10" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="">Full Name</label>
                            <input type="text" name="customer[fullname]" class="form-control" autocomplete="off">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="">Email</label>
                            <input type="text" name="customer[email]" class="form-control" autocomplete="off">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="">Address</label>
                    <textarea name="customer[address]" class="form-control" rows="2" autocomplete="off"></textarea>
                </div>
            </div>

            <script>
                $('[name="customer[mobile]"]').keyup(function () {
                    input = $(this);
                    $('[name="customer[fullname]"]').val('');
                    $('[name="customer[email]"]').val('');
                    $('[name="customer[address]"]').val('');
                    $('[name="customer[fullname]"]').removeAttr('readonly');
                    $('[name="customer[email]"]').removeAttr('readonly');
                    $('[name="customer[address]"]').removeAttr('readonly');

                    if (this.value.length == 10) {
                        input.attr('disabled', 'true')
                        $.ajax({
                            type: "GET", url: './api/table.php?select=customer', data: { where: { id: input.val() } }, async: false, cache: false, dataType: 'json'
                        }).done(function (response) {
                            // data = JSON.parse(response.data);
                            data = response.query.data[0];
                            console.log(data);

                            if (data != null) {
                                // console.log(data.name);
                                $('[name="customer[fullname]"]').val(data.name);
                                $('[name="customer[email]"]').val(data.email);
                                $('[name="customer[address]"]').val(data.address);

                                $('[name="customer[fullname]"]').attr('readonly', 'true');
                                $('[name="customer[email]"]').attr('readonly', 'true');
                                $('[name="customer[address]"]').attr('readonly', 'true');
                            }

                            input.removeAttr('disabled');
                        })
                    }
                })
            </script>
        </div>
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-end justify-content-between">
                    <div class="col-8 small font-weight-bold align-items-start">
                        <label for="">Product Name</label>
                        <select class="form-control product_id_in">
                            <option value="">--- Select Product ---</option>
                        </select>
                    </div>
                    <div class="col-4 small font-weight-bold align-items-start">
                        <label for="">Barcode</label>
                        <input type="text" class="form-control barcode_in">
                    </div>
                </div>
                <hr>
                <div class="table-responsive">
                    <table id="product_table" class="table table-bordered empty-table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>HSN</th>
                                <th>Barcode</th>
                                <th>Price</th>
                                <th>GST %</th>
                                <th>Amount</th>
                                <th>Quantity</th>
                                <th>Total Price</th>
                                <th>Total GST</th>
                                <th>Total Amount</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- <tr>
                                <td colspan="11" class="text-center no-data">No Products Added</td>
                            </tr> -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card">

            <div class="card-body">
                <div class="d-flex mb-3 align-items-center justify-content-between">
                    <p class="m-0">Sub Total : </p>
                    <p class="m-0 d-flex align-items-center">₹ <input type="text" name="sub_total" value="0" maxlength="2" readonly class="form-control total_taxable_amount text-right"></p>
                </div>
                <div class="d-flex mb-3 form-inline justify-content-between align-items-center">
                    <label for="">Discount : </label>
                    <p class="m-0 d-flex align-items-center"><input type="text" value="0" name="discount" class="form-control text-right discount"></p>
                </div>
                <div class="d-flex mb-3 align-items-center justify-content-between">
                    <p class="m-0">Net Total : </p>
                    <p class="m-0 d-flex align-items-center">₹ <input type="text" name="net_total" readonly class="form-control text-right" value="0.00"></p>
                </div>
                <hr>
                <div class="d-flex align-items-center justify-content-between">
                    <p class="m-0">SGST : </p>
                    <p class="m-0 d-flex align-items-center">₹ <input type="text" readonly name="sgst_amount" class="form-control text-right font-weight-bold total_sgst_amount" value="0.00"></p>
                </div>
                <div class="d-flex align-items-center justify-content-between">
                    <p class="m-0">CGST : </p>
                    <p class="m-0 d-flex align-items-center">₹ <input type="text" readonly name="cgst_amount" class="form-control text-right font-weight-bold total_cgst_amount" value="0.00"></p>
                </div>
                <hr>
                <div class="d-flex align-items-center justify-content-between h5 m-0">
                    <p class="m-0">Grand Total : </p>
                    <p class="m-0 d-flex align-items-center"> <input type="text" readonly name="grand_total" class="form-control text-right font-weight-bold grand_total" value="0.00"></p>
                </div>
                <div class="d-flex align-items-center justify-content-between h5 m-0">
                    <p class="h5">In Words : </p>
                    <p> <span class="form-control amount-in-words text-capitalize" readonly></span></p>
                </div>
                <hr>
                <div class="d-flex justify-content-end align-items-center">
                    <button class="btn btn-success lock_invoice" type="button"><i class="fa fa-shopping-cart"></i> Checkout</button>
                </div>
            </div>
    </form>
</div>

<script> // Initial
    $(document).ready(function () {
        $('.product_id_in').html(options('./api/table.php?select=product'));

    })
</script>

<script> // Product Table Update
    $('.product_id_in').change(function () {
        $('.product_id_in').val();

        product_id = $('.product_id_in').val();

        if (product_id != '') {
            if ($('#product_table tbody').find('.no-data').hasClass('no-data')) {
                i = 0;
            } else {
                i = $('#product_table tbody tr').length;
            }
            $('#product_table tbody').find('.no-data').remove()
            $.ajax({
                url: './api/table.php',
                type: "POST", async: false, cache: false, dataType: 'json',
                data: { join: { table1: 'product', table2: 'gst_slab', id1: 'gst_id', id2: 'id', seq: 'product.*,gst_slab.tax_percent' }, where: { 'product.id': product_id } }
            }).done(function (response) {
                // data = JSON.parse(response.data);
                data = response.query.data[0];
                console.log(data);

                $('#product_table tbody').append(`
                    <tr data-row-index="${i}">
                        <td class="text-nowrap">
                            <input type="hidden" class="form-control" name="products[${i}][id]" value="${data.id}" readonly>
                            <input type="text" class="form-control" name="products[${i}][name]" value="${data.name}" readonly>
                            </td>
                        <td><input type="text" class="form-control" name="products[${i}][HSN]" value="${data.hsn}" readonly></td>
                        <td><input type="text" class="form-control" name="products[${i}][barcode]" value="${data.barcode}" readonly></td>                               
                       <td><input type="text" class="form-control price" name="products[${i}][price]" style="min-width: 100px;" value="${Number(data.selling_cost / Number(data.tax_percent / Number(100) + Number(1))).toFixed(2)}"></td>
                        <td><input type="text" class="form-control" name="products[${i}][tax_percent]" value="${data.tax_percent}" readonly></td>
                        <td><input type="text" class="form-control amount" name="products[${i}][amount]" style="min-width: 100px;" value="${data.selling_cost}"></td>
                        <td><input type="text" class="form-control" name="products[${i}][unit]" value="1" style="min-width: 100px;"></td>
                        <td><input type="text" class="form-control total_price" name="products[${i}][total_price]" value="0" readonly></td>
                        <td><input type="text" class="form-control total_gst" name="products[${i}][total_gst]" value="0" readonly></td>
                        <td><input type="text" class="form-control" name="products[${i}][total_amount]" value="0" readonly></td>
                
                        <td><button class="btn btn-sm btn-danger rounded-circle delete-row" type="button"><i class="fa fa-times"></i></button></td>
                    </tr>
                `);
            });
        }
    })
    $(document).on('click', '.delete-row', function () {
        $(this).closest('tr').remove();
        if ($('#product_table tbody tr').length == 1) {
            // $('#product_table tbody').html('<tr><td colspan="9" class="text-center no-data">No Products Added</td></tr>')
        }
    })
</script>

<script> // Load Saved Inovice
    $(document).ready(function () {
        if (localStorage.getItem("invoice_id") === null) {
            screen_loader('checkout/list');
        } else {
            $('[name="invoice_id"]').val(localStorage.getItem('invoice_id'));

            if ($('[name="invoice_id"]') != 'new') {
                id = $('[name="invoice_id"]').val();

                $.ajax({
                    type: "POST", url: './api/table.php?select=checkout', data: { where: { id: id } }, async: false, cache: false, dataType: 'json'
                }).done(function (response) {
                    // data = JSON.parse(response.data);
                    data = response.query.data[0];
                    console.log(data);

                    if (data != null) {
                        $.ajax({
                            type: "POST", url: './api/table.php?select=customer', data: { where: { mobile: data.customer } }, async: false, cache: false, dataType: 'json'
                        }).done(function (response) {
                            // invoice = response.data;
                            // customer = JSON.parse(data.customer);
                            customer = response.query.data[0];
                            if (customer != null) {
                                $('[name="customer[mobile]"]').attr('readonly', 'true');
                                $('[name="customer[fullname]"]').attr('readonly', 'true');
                                $('[name="customer[email]"]').attr('readonly', 'true');
                                $('[name="customer[address]"]').attr('readonly', 'true');

                                $('[name="customer[fullname]"]').val(customer.name);
                                $('[name="customer[email]"]').val(customer.email);
                                $('[name="customer[mobile]"]').val(customer.mobile);
                                $('[name="customer[address]"]').val(customer.address);
                            }
                        })


                        if (data.products != null) {
                            $('#product_table tbody').html('');

                            data.products.forEach(data => {
                                i = $('#product_table tbody tr').length;
                                $('#product_table tbody').append(`
                                <tr data-row-index="${i}">
                                    <td class="text-nowrap">
                                        <input type="hidden" class="form-control" name="products[${i}][id]" value="${data.id}" readonly>
                                        <input type="text" class="form-control" name="products[${i}][name]" value="${data.name}" readonly>
                                    </td>
                                    <td><input type="text" class="form-control" name="products[${i}][HSN]" value="${data.HSN}" readonly></td>
                                        <td><input type="text" class="form-control" name="products[${i}][barcode]" value="${data.barcode}" readonly></td>                               
                                    <td><input type="text" class="form-control price" name="products[${i}][price]" value="${data.price}" style="min-width: 100px;"></td>
                                    <td><input type="text" class="form-control" name="products[${i}][tax_percent]" value="${data.tax_percent}" readonly></td>
                                    <td><input type="text" class="form-control amount" name="products[${i}][amount]" value="${data.amount}" style="min-width: 100px;"></td>
                                    <td><input type="text" class="form-control" name="products[${i}][unit]" value="${data.unit}" style="min-width: 100px;"></td>
                                    <td><input type="text" class="form-control total_price" name="products[${i}][total_price]" value="${data.total_price}" readonly></td>
                                    <td><input type="text" class="form-control total_gst" name="products[${i}][total_gst]" value="${data.total_gst}" readonly></td>
                                    <td><input type="text" class="form-control" name="products[${i}][total_amount]" value="${data.total_amount}" readonly></td>
                                    <td><button class="btn btn-sm btn-danger rounded-circle delete-row" type="button"><i class="fa fa-times"></i></button></td>
                                </tr>
                            `);
                            });
                        }


                        sub_total = 0;
                        sgst = 0;
                        cgst = 0;

                        $.each($('table .total_price'), function () { sub_total = sub_total + Number($(this).val()) })
                        $.each($('table .total_gst'), function () { sgst = sgst + (Number($(this).val()) / 2) })
                        $.each($('table .total_gst'), function () { cgst = cgst + (Number($(this).val()) / 2) })

                        $('[name="discount"]').val(data.discount);
                        $('[name="sub_total"]').val(sub_total.toFixed(2));
                        $('[name="sgst_amount"]').val(sgst.toFixed(2));
                        $('[name="cgst_amount"]').val(cgst.toFixed(2));
                        $('[name="net_total"]').val(sub_total - percentage($('[name="discount"]').val(), sub_total));
                        $('[name="grand_total"]').val(Number($('[name="net_total"]').val()) + sgst + cgst);

                        $('.amount-in-words').html(inWords($('[name="grand_total"]').val()));
                    }

                });
            }
        }
    })
</script>

<script> // Product Table Calculation
    $(document).on('keyup', 'table .form-control', function () {
        input = $(this);
        tr = $(this).closest('tr');
        i = $(this).closest('tr').attr('data-row-index');

        price = tr.find(`[name="products[${i}][price]"]`);
        amount = tr.find(`[name="products[${i}][amount]"]`);
        tax = tr.find(`[name="products[${i}][tax_percent]"]`);
        unit = tr.find(`[name="products[${i}][unit]"]`);
        total_price = tr.find(`[name="products[${i}][total_price]"]`);
        total_gst = tr.find(`[name="products[${i}][total_gst]"]`);
        total_amount = tr.find(`[name="products[${i}][total_amount]"]`);

        if (input.hasClass('price')) amount.val((Number(price.val()) + percentage(tax.val(), price.val())).toFixed(2));
        if (input.hasClass('amount')) price.val((amount.val() / Number(tax.val() / 100 + Number(1))).toFixed(2));

        total_price.val((Number(price.val()) * Number(unit.val())));
        total_gst.val(((Number(amount.val()) - Number(price.val())) * Number(unit.val())).toFixed(2));
        total_amount.val((Number(amount.val()) * Number(unit.val())).toFixed(2));

        sub_total = 0;
        sgst = 0;
        cgst = 0;

        $.each($('table .total_price'), function () { sub_total = sub_total + Number($(this).val()) })
        $.each($('table .total_gst'), function () { sgst = sgst + (Number($(this).val()) / 2) })
        $.each($('table .total_gst'), function () { cgst = cgst + (Number($(this).val()) / 2) })

        $('[name="sub_total"]').val(sub_total.toFixed(2));
        $('[name="sgst_amount"]').val(sgst.toFixed(2));
        $('[name="cgst_amount"]').val(cgst.toFixed(2));


        $('[name="net_total"]').val(sub_total - percentage($('[name="discount"]').val(), sub_total));
        grand_total = Number($('[name="net_total"]').val()) + sgst + cgst;

        $('[name="grand_total"]').val((grand_total).toFixed(2));
        $('.grand_total').text((grand_total).toFixed(2));

        $('.amount-in-words').html(inWords(grand_total));

        $('.discount').keyup(function () {
            $('[name="net_total"]').val(Number($('[name="sub_total"]').val()) - percentage($(this).val(), $('[name="sub_total"]').val()).toFixed(2))
            $('[name="grand_total"]').val((Number($('[name="net_total"]').val()) + Number($('[name="sgst_amount"]').val()) + Number($('[name="sgst_amount"]').val())).toFixed(2))

            $('.amount-in-words').html(inWords($('[name="grand_total"]').val()));
            $('.grand_total').text((grand_total).toFixed(2));

        })
    })
</script>

<script> // Save Invoice
    $('.save_invoice').click(function (e) {
        e.preventDefault();

        form = $('#save_invoice');

        $formObj = $('#save_invoice').serializeObject();

        if ($('[name="customer[mobile]"]').val() != '') {
            if (form.serializeObject().products != null) {
                if ($('[name="invoice_id"]').val() == 'new') {
                    $.ajax({
                        type: "GET", url: './api/table.php?getMax=id&from=checkout', dataType: 'json',
                    }).done(function (response) {
                        console.log(response);
                        data = {
                            column: {
                                id: Number(response.query.data) + 1,
                                sub_total: $('[name="sub_total"]').val(),
                                discount: $('[name="discount"]').val(),
                                customer: $('[name="customer[mobile]"]').val(),
                                products: JSON.stringify(form.serializeObject().products),
                                net_total: $('[name="net_total"]').val(),
                                sgst_amount: $('[name="sgst_amount"]').val(),
                                cgst_amount: $('[name="cgst_amount"]').val(),
                                grand_total: $('[name="grand_total"]').val(),
                                due_amount: $('[name="due_amount"]').val(),
                                datetime: getDatetime(),
                            }
                        }
                        // console.log(data);
                        $.ajax({
                            type: "POST", url: './api/table.php?insert=checkout', data: data, dataType: 'json',
                        }).done(function (response) {
                            console.log(response);

                            if (response.query.status) {
                                localStorage.removeItem('invoice_id');
                                if (localStorage.getItem("invoice_id") === null) {
                                    screen_loader('checkout/list');
                                } else {
                                    console.log('error');
                                }
                            } else {
                                $('.alert-holder').html(b_alert('danger', 'Error'));
                            }
                        });
                    });
                } else {
                    data = {
                        column: {
                            sub_total: $('[name="sub_total"]').val(),
                            discount: $('[name="discount"]').val(),
                            customer: JSON.stringify(form.serializeObject().customer),
                            products: JSON.stringify(form.serializeObject().products),
                            net_total: $('[name="net_total"]').val(),
                            sgst_amount: $('[name="sgst_amount"]').val(),
                            cgst_amount: $('[name="cgst_amount"]').val(),
                            grand_total: $('[name="grand_total"]').val(),
                            due_amount: $('[name="due_amount"]').val(),
                            datetime: getDatetime(),
                        },
                        where: { id: $('[name="invoice_id"]').val() }
                    }
                    // console.log(data);
                    $.ajax({
                        type: "POST", url: './api/table.php?update=checkout', data: data, dataType: 'json',
                    }).done(function (response) {
                        if (response.query.status) {
                            $('.alert-holder').html(b_alert('success', 'Invoice Updated'));
                        } else {
                            $('.alert-holder').html(b_alert('danger', 'Error'));
                        }
                    });

                }
            } else {
                alert('Please Add Products');
            }
        } else {
            alert('Select Add Customer');
        }
    })
</script>

<script> //lock invoice

    $('.lock_invoice').click(function () {
        if ($('[name="customer[mobile]"]').val() != '') {
            form = $('#save_invoice');
            if (form.serializeObject().products != null) {
                if (confirm('Are You Ready To Lock Invoice ?')) {
                    alert('Invoice Locked');
                    $.ajax({
                        type: "POST",
                        url: './api/checkout_crud.php?crud=lock&id=' + $('[name="invoice_id"]').val(),
                        data: form.serialize(), // serializes the form's elements.
                        dataType: 'json',
                    }).done(function (response) {
                        if (response.status) {
                            localStorage.setItem('invoice_id', response.invoice_id);
                            if (localStorage.getItem("invoice_id") !== null) {
                                console.log('ok');
                                screen_loader('checkout/view');
                            } else {
                                console.log('error');
                            }
                        } else {
                            $('.alert-holder').html(b_alert('danger', 'Error'));
                        }
                        // screen_loader('checkout/list');
                    });
                }
            } else {
                alert('Please Add Products');
            }
        } else {
            alert('Select Add Customer');
        }
    })
</script>

<script> // Exit inovice
    $('.exit_invoice').click(function () {
        localStorage.removeItem('invoice_id');
        if (localStorage.getItem("invoice_id") === null) {
            screen_loader('checkout/list');
        } else {
            console.log('error');
        }
    })
</script>